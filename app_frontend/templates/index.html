{% extends "base.html" %}

{% block title %}Order Service - {{ business_config['businessName'] }}{% endblock %}

{% block content %}
<div class="text-center">
    <h1 class="mb-4">Order Service</h1>
    <p>{{ business_config['businessDescription'] }}</p>

    <form id="orderForm" class="mx-auto" style="max-width: 500px;">
        <div class="mb-3">
            <label class="form-label">Service Type</label>
            <div id="serviceCards">
                {% for service in business_config['services'] %}
                <div class="service-card-wrapper">
                    <div class="card service-card" 
                         data-service="{{ service['name'].lower().replace(' ', '_') }}" 
                         data-price="{{ service['price'] }}"
                         data-subscription-available="{{ service['subscription']['available'] }}"
                         data-subscription-price="{{ service['subscription']['monthlyPrice'] }}"
                         data-subscription-quantity="{{ service['subscription']['quantityPerMonth'] }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ service['name'] }}</h5>
                            <p class="card-text mb-1">One-time: ${{ service['price'] }}</p>
                            {% if service['subscription']['available'] %}
                            <p class="text-center my-1"><em>or</em></p>
                            <p class="card-text mb-1">Subscription: ${{ service['subscription']['monthlyPrice'] }}/month</p>
                            <p class="card-text">({{ service['subscription']['quantityPerMonth'] }} services/month)</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="mb-3">
            <label for="orderType" class="form-label">Order Type</label>
            <select class="form-select" id="orderType">
                <option value="">Select a service first</option>
            </select>
        </div>

        <div class="mb-3" id="quantityField">
            <label for="quantity" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="quantity" min="1" value="1" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Total</label>
            <div id="total" class="form-control-plaintext">$0.00</div>
        </div>

        <button type="submit" class="btn btn-primary">Place Order</button>
    </form>

    <div id="orderConfirmation" class="mt-4" style="display: none;">
        <h2>Order Confirmation</h2>
        <p>Your order has been placed successfully. Order ID: <span id="orderId"></span></p>
        <p><strong>Payment: In-person at pickup. Online payment coming soon!</strong></p>
        <button id="printReceipt" class="btn btn-secondary">Print Receipt</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const form = document.getElementById('orderForm');
    const serviceCards = document.getElementById('serviceCards');
    const orderType = document.getElementById('orderType');
    const quantityField = document.getElementById('quantityField');
    const quantity = document.getElementById('quantity');
    const total = document.getElementById('total');
    const orderConfirmation = document.getElementById('orderConfirmation');
    const orderId = document.getElementById('orderId');
    const printReceipt = document.getElementById('printReceipt');

    let selectedService = null;

    function updateOrderTypeOptions() {
        orderType.innerHTML = '';
        if (selectedService) {
            const oneTimeOption = document.createElement('option');
            oneTimeOption.value = 'one-time';
            oneTimeOption.textContent = 'One-time Order';
            orderType.appendChild(oneTimeOption);

            if (selectedService.dataset.subscriptionAvailable === 'True') {
                const subscriptionOption = document.createElement('option');
                subscriptionOption.value = 'subscription';
                subscriptionOption.textContent = 'Subscription';
                orderType.appendChild(subscriptionOption);
            }
        } else {
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a service first';
            orderType.appendChild(defaultOption);
        }
        updateTotal();
    }

    function updateTotal() {
        if (selectedService && orderType.value) {
            const isSubscription = orderType.value === 'subscription';
            const price = isSubscription
                ? parseFloat(selectedService.dataset.subscriptionPrice)
                : parseFloat(selectedService.dataset.price);
            const qty = isSubscription ? 1 : parseFloat(quantity.value);
            const totalPrice = price * qty;
            total.textContent = `$${totalPrice.toFixed(2)}`;
        } else {
            total.textContent = '$0.00';
        }
    }

    serviceCards.addEventListener('click', (e) => {
        const card = e.target.closest('.service-card');
        if (card) {
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedService = card;
            updateOrderTypeOptions();
        }
    });

    orderType.addEventListener('change', () => {
        quantityField.style.display = orderType.value === 'subscription' ? 'none' : 'block';
        updateTotal();
    });

    quantity.addEventListener('input', updateTotal);

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedService || !orderType.value) {
            alert('Please select a service and order type');
            return;
        }
        const formData = new FormData(form);
        formData.append('service_type', selectedService.dataset.service);
        formData.append('order_type', orderType.value);
        formData.append('quantity', orderType.value === 'subscription' ? '1' : quantity.value);
        formData.append('total', total.textContent.substring(1));

        try {
            const response = await fetch('/place_order', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                orderConfirmation.style.display = 'block';
                form.style.display = 'none';
                orderId.textContent = data.order_id;
            } else {
                throw new Error('Failed to place order');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while placing the order. Please try again.');
        }
    });

    printReceipt.addEventListener('click', () => {
        window.print();
    });
</script>
{% endblock %}

{% block page_specific_css %}
<style>
    #serviceCards {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
    }

    .service-card-wrapper {
        flex: 1 1 200px;
        max-width: 300px;
        display: flex;
    }

    .service-card {
        width: 100%;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #e0e0e0;
    }

    .service-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .service-card.selected {
        background-color: #f8f9fa;
        border-color: #025;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .service-card .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 1rem;
    }

    .service-card .card-title {
        margin-bottom: 0.5rem;
    }

    .service-card .card-text {
        margin-bottom: 0.25rem;
    }

    .service-card p.text-center {
        font-style: italic;
        color: #6c757d;
        margin: 0.25rem 0;
    }

    .service-card hr {
        border-top: 1px solid #dee2e6;
        width: 80%;
        margin-left: auto;
        margin-right: auto;
    }

    .service-card p.text-center {
        font-style: italic;
        color: #6c757d;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }

    body.dark-mode .service-card {
        border-color: #4a4a4a;
    }

    body.dark-mode .service-card.selected {
        background-color: #2c3e50;
        border-color: #3498db;
    }

    #total.form-control-plaintext {
        padding: 0.375rem 0.75rem;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }

    @media (max-width: 768px) {
        .service-card-wrapper {
            flex-basis: 100%;
        }
    }
</style>
{% endblock %}
